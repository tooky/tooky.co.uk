<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Steve Tooke - Your tests want you to change your design</title>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Merriweather:300italic,300|Source+Sans+Pro:300|Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link href="/stylesheets/reset.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/highlight.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/blog.css" rel="stylesheet" type="text/css" />
    <script src="/javascripts/track_outbound_links.js" type="text/javascript"></script>

  </head>
  <body>

  <div id='site-header'>
    <div id="site-header-wrapper">
      <h1>
        <a href="/">
          Steve Tooke
        </a>
      </h1>
      <h2>software development flavoured with agile, bdd, ruby and javascript</h2>
    </div>
  </div>
  <div id='main-wrapper'>
    <div id="main" role="main">
        <article>
    <header>
      <h1>Your tests want you to change your design</h1>
      <section class="author">
        <img class="avatar" src="/images/tooky-avatar.jpg">
        <p class="byline">by Steve Tooke</p>
        <time datetime="2014-12-19" itemprop="datePublished">December 19th, 2014</time>
      </section>
    </header>
    <section class="article-body">
      <p>I came across an interesting post by <a href="https://twitter.com/brandonhilkert">Brandon Hilkert</a> looking at <a href="http://brandonhilkert.com/blog/a-ruby-refactor-exploring-dependency-injection-options/">the
differences between constructor and setter dependency injection</a>. It&rsquo;s
a great introduction to the differences between the two, and his example
illustrates them well. Please go and read it first.</p>

<p>Brandon&rsquo;s example gets started when he realises that the tests he wants to write
are difficult:</p>

<blockquote>
<p>[A] thing that bothered me was the difficulty simulating different pricing
tiers and customer usage&hellip;What if I wanted to change the ceiling of that
tier next month? I&rsquo;d have to come in here and adjust the stats being created
until it totalled something above the adjustment. It just felt weird..</p>
</blockquote>

<p>He uses this as an example of how we can use dependency injection to use
different collaborators in tests so we get more control over the context our
objects are running in.</p>

<p>The solution he settles on is to use setter injection:</p>
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">StripeEvent</span>
  <span class="k">class</span> <span class="nc">InvoiceCreated</span>
    <span class="kp">attr_writer</span> <span class="ss">:usage_service</span>
    <span class="kp">attr_reader</span> <span class="ss">:payload</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
      <span class="vi">@payload</span> <span class="o">=</span> <span class="n">payload</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">perform</span>
      <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">created_at</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span>
        <span class="no">Stripe</span><span class="o">::</span><span class="no">InvoiceItem</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
          <span class="ss">customer: </span><span class="n">user</span><span class="p">.</span><span class="nf">stripe_id</span><span class="p">,</span>
          <span class="ss">amount: </span><span class="n">additional_charges_in_cents</span><span class="p">,</span>
          <span class="ss">currency: </span><span class="s2">"usd"</span><span class="p">,</span>
          <span class="ss">description: </span><span class="s2">"Usage charges"</span>
        <span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">additional_charges_in_cents</span>
      <span class="no">Billing</span><span class="o">::</span><span class="no">Tier</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">usage</span><span class="p">).</span><span class="nf">additional_charges_in_cents</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">usage</span>
      <span class="n">usage_service</span><span class="p">.</span><span class="nf">last_30_days</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">usage_service</span>
      <span class="vi">@usage_service</span> <span class="o">||=</span> <span class="no">Billing</span><span class="o">::</span><span class="no">Usage</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">user</span>
      <span class="vi">@user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">stripe_id: </span><span class="n">payload</span><span class="p">[</span><span class="s2">"data"</span><span class="p">][</span><span class="s2">"object"</span><span class="p">][</span><span class="s2">"customer"</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre>

<p>He&rsquo;s now able to take an initialized object and using the <code>attr_writer
:usage_service</code> he can swap in a stub implementation of the usage service and
tightly control what is returned. It allows him to ignor the <em>incidental detail</em>
of creating a <code>Stat</code>.</p>

<p>When tests are difficult to write they are a great indicator that there&rsquo;s
something about our design that we should take another look at. I&rsquo;m not sure
that adding the setter method really changes the design, it just hides a little
complexity when writing our tests.</p>

<p>Here&rsquo;s the sequence diagram for the original code:</p>

<p><img alt="original sequence" src="https://dl.dropboxusercontent.com/u/41915/tooky-images/listening_to_tests_1.png" /></p>

<p>Using the setter to inject a usage service shortcuts creating the usage service,
but is <em>only</em> relevant in the tests &mdash; in normal usage the design is
<em>exactly</em> the same.</p>

<p><img alt="setter sequence" src="https://dl.dropboxusercontent.com/u/41915/tooky-images/listening_to_tests_2.png" /></p>

<p>The tests were hinting that we had too many responsibilities, but this sequence
diagram really highlights this:</p>

<ul>
<li>Retrieve a user</li>
<li>Get the users usage for the last 30 days</li>
<li>Get the billing tier for that usage</li>
<li>Create an invoice item for the billing tier amount</li>
</ul>

<p>The last one is the most important. We want to create an additional invoice item
for the user, based on their usage in the last 30 days., and 
sequence diagram looked something like:</p>

<p><img alt="extracted dependencies sequence" src="https://dl.dropboxusercontent.com/u/41915/tooky-images/listening_to_tests_3.png" /></p>

<p>Based on this idea I changed the tests to focus the object on the responsibility
we care about:</p>
<pre><code class="highlight ruby"><span class="n">describe</span> <span class="s2">"creating an invoice"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@payload</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">"data"</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="s2">"object"</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="s2">"customer"</span> <span class="o">=&gt;</span> <span class="s2">"stripe_brandon"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:billing_tier_service</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="ss">:billing_tier_service</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:level1</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="ss">:tier</span><span class="p">,</span> <span class="ss">:additional_charges_in_cents</span> <span class="o">=&gt;</span> <span class="mi">1900</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:level2</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="ss">:tier</span><span class="p">,</span> <span class="ss">:additional_charges_in_cents</span> <span class="o">=&gt;</span> <span class="mi">4900</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s1">'adds invoice item based on usage'</span> <span class="k">do</span>
    <span class="n">allow</span><span class="p">(</span><span class="n">billing_tier_service</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:last_30_days_for_stripe_id</span><span class="p">).</span>
      <span class="nf">with</span><span class="p">(</span><span class="s2">"stripe_brandon"</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="n">level1</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">InvoiceItem</span> <span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:create</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span>
      <span class="ss">customer: </span><span class="s2">"stripe_brandon"</span><span class="p">,</span>
      <span class="ss">amount: </span><span class="mi">1900</span><span class="p">,</span>
      <span class="ss">currency: </span><span class="s2">"usd"</span><span class="p">,</span>
      <span class="ss">description: </span><span class="s2">"Usage charges"</span>
    <span class="p">)</span>
    <span class="no">StripeEvent</span><span class="o">::</span><span class="no">InvoiceCreated</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@payload</span><span class="p">,</span> <span class="n">billing_tier_service</span><span class="p">).</span><span class="nf">perform</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'adds next level charge for usage'</span> <span class="k">do</span>
    <span class="n">allow</span><span class="p">(</span><span class="n">billing_tier_service</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:last_30_days_for_stripe_id</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="s2">"stripe_brandon"</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="n">level2</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">InvoiceItem</span> <span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:create</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span>
      <span class="ss">customer: </span><span class="s2">"stripe_brandon"</span><span class="p">,</span>
      <span class="ss">amount: </span><span class="mi">4900</span><span class="p">,</span>
      <span class="ss">currency: </span><span class="s2">"usd"</span><span class="p">,</span>
      <span class="ss">description: </span><span class="s2">"Usage charges"</span>
    <span class="p">)</span>
    <span class="no">StripeEvent</span><span class="o">::</span><span class="no">InvoiceCreated</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@payload</span><span class="p">,</span> <span class="n">billing_tier_service</span><span class="p">).</span><span class="nf">perform</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We are injecting a new dependency, a <code>billing_tier_service</code>. We&rsquo;re imagining
that this dependency will take on the responsibility of giving us back the
correct billing tier for the customer that stripe has asked us for. Our tests
will just check we creating the InvoiceItem correctly, and the resulting code
is little simpler.</p>
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">StripeEvent</span>
  <span class="k">class</span> <span class="nc">InvoiceCreated</span>
    <span class="kp">attr_reader</span> <span class="ss">:payload</span>
    <span class="kp">attr_reader</span> <span class="ss">:billing_tier_service</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">billing_tier_service</span> <span class="o">=</span> <span class="ss">:some_sensible_default</span><span class="p">)</span>
      <span class="vi">@payload</span> <span class="o">=</span> <span class="n">payload</span>
      <span class="vi">@billing_tier_service</span> <span class="o">=</span> <span class="n">billing_tier_service</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">perform</span>
      <span class="no">Stripe</span><span class="o">::</span><span class="no">InvoiceItem</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="ss">customer: </span><span class="n">stripe_id</span><span class="p">,</span>
        <span class="ss">amount: </span><span class="n">additional_charges_in_cents</span><span class="p">,</span>
        <span class="ss">currency: </span><span class="s2">"usd"</span><span class="p">,</span>
        <span class="ss">description: </span><span class="s2">"Usage charges"</span>
      <span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">additional_charges_in_cents</span>
      <span class="n">tier</span> <span class="o">=</span> <span class="n">billing_tier_service</span><span class="p">.</span><span class="nf">last_30_days_for_stripe_id</span><span class="p">(</span><span class="n">stripe_id</span><span class="p">)</span>
      <span class="n">tier</span><span class="p">.</span><span class="nf">additional_charges_in_cents</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">stripe_id</span>
      <span class="n">payload</span><span class="p">[</span><span class="s2">"data"</span><span class="p">][</span><span class="s2">"object"</span><span class="p">][</span><span class="s2">"customer"</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Obviously this leaves us with more work to do. We will still need to build the
<code>billing_tier_service</code>, to return the current tier for the customer. But this
should be simpler, and focus purely on which level is returned based on usage.</p>

<p>The trade-off is that we now have to deal with more objects in our system, but
each responsibility is in a single place, and our tests are isolated from
incidental changes in other parts of the system, e.g. changing the tier pricing.</p>

<p>Test driven development is about listening to your tests. When something is hard
to test it&rsquo;s usually a good indicator that you should change something in your
design. Use it as an opportunity to reevaluate design &mdash; and don&rsquo;t be
afraid of breaking out some boxes and arrows on the whiteboard.</p>

    </section>
  </article>

    </div>

    <aside id="sidebar">
      <ol id="recent-articles">
        <h2>
          Recent Articles
          <a href="/feed.xml" class="feed" title="Subscribe!"><i class="fa fa-rss"></i></a>
        </h2>
          <li><a href="/the-mob-rules-ok/">The mob rules, ok?</a> <span>Dec  1</span></li>
          <li><a href="/hands-on-with-cucumber-events-api/">Hands-on With the Cucumber Events API</a> <span>Sep 14</span></li>
          <li><a href="/your-tests-want-you-to-change-your-design/">Your tests want you to change your design</a> <span>Dec 19</span></li>
          <li><a href="/test-first-diamonds/">Test first diamonds</a> <span>Dec  6</span></li>
          <li><a href="/connascence-and-inverting-dependencies/">Connascence and Inverting Dependencies</a> <span>Nov  7</span></li>
      </ol>

      <ul id="tags">
        <h2>Tags</h2>
          <li><a href="/tags/design/">Design</a></a></li>
          <li><a href="/tags/kata/">Kata</a></a></li>
          <li><a href="/tags/tdd/">TDD</a></a></li>
          <li><a href="/tags/apprenticeship/">apprenticeship</a></a></li>
          <li><a href="/tags/atdd/">atdd</a></a></li>
          <li><a href="/tags/bdd/">bdd</a></a></li>
          <li><a href="/tags/bletchley-park/">bletchley park</a></a></li>
          <li><a href="/tags/charlock_holmes/">charlock_holmes</a></a></li>
          <li><a href="/tags/chris-matts/">chris-matts</a></a></li>
          <li><a href="/tags/coderetreat/">coderetreat</a></a></li>
          <li><a href="/tags/connascence/">connascence</a></a></li>
          <li><a href="/tags/corey-haines/">corey-haines</a></a></li>
          <li><a href="/tags/craft/">craft</a></a></li>
          <li><a href="/tags/craftsmanship/">craftsmanship</a></a></li>
          <li><a href="/tags/cucumber/">cucumber</a></a></li>
          <li><a href="/tags/cynefin/">cynefin</a></a></li>
          <li><a href="/tags/deploymnent/">deploymnent</a></a></li>
          <li><a href="/tags/design/">design</a></a></li>
          <li><a href="/tags/dev/">dev</a></a></li>
          <li><a href="/tags/development/">development</a></a></li>
          <li><a href="/tags/eden/">eden</a></a></li>
          <li><a href="/tags/environment/">environment</a></a></li>
          <li><a href="/tags/fitnesse/">fitnesse</a></a></li>
          <li><a href="/tags/git/">git</a></a></li>
          <li><a href="/tags/github/">github</a></a></li>
          <li><a href="/tags/hacks/">hacks</a></a></li>
          <li><a href="/tags/heroku/">heroku</a></a></li>
          <li><a href="/tags/javascript/">javascript</a></a></li>
          <li><a href="/tags/jekyll/">jekyll</a></a></li>
          <li><a href="/tags/kickstartac/">kickstartac</a></a></li>
          <li><a href="/tags/libicu/">libicu</a></a></li>
          <li><a href="/tags/liz-keogh/">liz-keogh</a></a></li>
          <li><a href="/tags/macosx/">macosx</a></a></li>
          <li><a href="/tags/mobprogramming/">mobprogramming</a></a></li>
          <li><a href="/tags/oo/">oo</a></a></li>
          <li><a href="/tags/oop/">oop</a></a></li>
          <li><a href="/tags/pairing/">pairing</a></a></li>
          <li><a href="/tags/podcast/">podcast</a></a></li>
          <li><a href="/tags/practices/">practices</a></a></li>
          <li><a href="/tags/project/">project</a></a></li>
          <li><a href="/tags/retrospective/">retrospective</a></a></li>
          <li><a href="/tags/ruby/">ruby</a></a></li>
          <li><a href="/tags/sandi-metz/">sandi-metz</a></a></li>
          <li><a href="/tags/sinatra/">sinatra</a></a></li>
          <li><a href="/tags/software/">software</a></a></li>
          <li><a href="/tags/solid/">solid</a></a></li>
          <li><a href="/tags/specification-by-example/">specification-by-example</a></a></li>
          <li><a href="/tags/tdd/">tdd</a></a></li>
          <li><a href="/tags/tools/">tools</a></a></li>
          <li><a href="/tags/training/">training</a></a></li>
          <li><a href="/tags/vim/">vim</a></a></li>
          <li><a href="/tags/xp/">xp</a></a></li>
      </ul>

      <div id="bio">
        <img class="avatar" src="/images/tooky-avatar.jpg">
        <h2>Steve Tooke</h2>
        <p>
        I am a programmer &mdash; consultant, trainer and coach &mdash;
        passionate about improving my craft and helping others improve
        theirs. I specialise in helping teams continue to deliver
        valuable software by improving their team practices and
        communication, and keeping their code maintainable.
        </p>
        <p>
        I co-organised Bootstrapd, a non-profit conference for
        bootstrapped startups in Europe. I am the co-founder of the
        Software Craftsmanship UK user group, and the HampshiRB ruby
        user group. I have spoken at the Scottish Ruby
        Conference and have run workshops at the London Software
        Craftsmanship Community. I am a member of the Cucumber core
        team.
        </p>
        <p>
        <a href="http://kickstartacademy.io">Kickstart Academy</a>
        </p>
      </div>
    </aside>
    <footer>
      <div id='site-footer'>
        <p>All content copyright Steve Tooke &copy; 2015 &middot; All rights reserved.</p>
        <p>Find me on <a href="http://twitter.com/tooky">Twitter</a> | <a href="https://plus.google.com/+SteveTooke-Heavies/">Google+</a></a></p>
    </div>
    </footer>
  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37664795-2', 'tooky.co.uk');
    ga('send', 'pageview');

  </script>
  </body>
</html>
