<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Steve Tooke - Connascence and Inverting Dependencies</title>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Merriweather:300italic,300|Source+Sans+Pro:300|Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link href="/stylesheets/reset.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/highlight.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/blog.css" rel="stylesheet" type="text/css" />
    <script src="/javascripts/track_outbound_links.js" type="text/javascript"></script>

  </head>
  <body>

  <div id='site-header'>
    <div id="site-header-wrapper">
      <h1>
        <a href="/">
          Steve Tooke
        </a>
      </h1>
      <h2>software development flavoured with agile, bdd, ruby and javascript</h2>
    </div>
  </div>
  <div id='main-wrapper'>
    <div id="main" role="main">
        <article>
    <header>
      <h1>Connascence and Inverting Dependencies</h1>
      <section class="author">
        <img class="avatar" src="/images/tooky-avatar.jpg">
        <p class="byline">by Steve Tooke</p>
        <time datetime="2014-11-07" itemprop="datePublished">November 7th, 2014</time>
      </section>
    </header>
    <section class="article-body">
      <p>Recently <a href="http://twitter.com/abernardes">Andre Bernardes</a> <a href="http://abernardes.github.io/2014/11/04/inverting-dependencies.html">wrote about inverting
dependencies</a> and a refactoring that he made in the <a href="http://rom-rb.org">Ruby Object
Mapper</a> codebase.</p>

<p>It&rsquo;s a great article and if you haven&rsquo;t read it yet it won&rsquo;t take you long.
Go on, I can wait.</p>

<p>The original code, however, doesn&rsquo;t simply provide a great example of code that
violates the <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle">Dependency Inversion Principle</a>. Let&rsquo;s take a closer look and
see what else we can find.</p>
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Adapter</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">def</span> <span class="nb">self</span><span class="p">.</span><span class="nf">setup</span><span class="p">(</span><span class="n">uri_string</span><span class="p">)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">Addressable</span><span class="o">::</span><span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">uri_string</span><span class="p">)</span>
    <span class="n">adapter</span> <span class="o">=</span>
        <span class="k">case</span> <span class="n">uri</span><span class="p">.</span><span class="nf">scheme</span>
        <span class="k">when</span> <span class="s1">'sqlite'</span><span class="p">,</span> <span class="s1">'jdbc'</span> <span class="k">then</span> <span class="no">Adapter</span><span class="o">::</span><span class="no">Sequel</span>
        <span class="k">when</span> <span class="s1">'memory'</span> <span class="k">then</span> <span class="no">Adapter</span><span class="o">::</span><span class="no">Memory</span>
        <span class="k">when</span> <span class="s1">'mongo'</span> <span class="k">then</span> <span class="no">Adapter</span><span class="o">::</span><span class="no">Mongo</span>
        <span class="k">else</span>
          <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">uri_string</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2"> uri is not supported"</span>
        <span class="k">end</span>

    <span class="n">adapter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>

<p>In 2010 I saw Jim Weirich speak about the <a href="http://vimeo.com/10837903">Grand Unified Theory of Software
Development</a> (this is the version from Aloha on Rails) where he introduced
his audience to the idea of <a href="http://en.wikipedia.org/wiki/Connascence_(computer_programming)">Connascence</a>.</p>

<blockquote>
<p>In software engineering, two components are connascent if a change in one
would require the other to be modified in order to maintain the overall
correctness of the system.</p>
</blockquote>

<p>Let&rsquo;s look again at the <code>Adapter</code> code through the lens of connascence.</p>

<p>The <code>setup</code> method is checking the scheme of the <code>uri</code> and deciding which
specific adapter to use in this instance. This is an example of <a href="http://en.wikipedia.org/wiki/Connascence_(computer_programming)#Connascence_of_Meaning_.28CoM.29">Connascence of
Meaning</a>.</p>

<p>As Andre pointed out in his post, adding a new adapter also means changing this
method. If an <code>Adapter</code> is changed to handle different schemes, then this method
will also need to change. They must change together because they share the
meaning of the URI scheme.</p>

<p>The refactoring that Andre has implemented doesn&rsquo;t rid us of Connascence of
Meaning but it reduces the <em>Degree</em> and increases the <em>Locality</em> of the
connascence.</p>

<p>When we are looking at connascence and deciding whether any particular instance
of connascence is acceptable, there are two concepts that we need to consider.</p>

<p>The degree of connascence is really about the volume of connascence, how much of
it we can see. Andre mentions in his post that the example presented above is
not terrible, but when he was about to add 19 more branches to the case
statement it would have become much worse. The degree of connascence would have
increased, and would only have continued increasing.</p>

<p>The locality of connascence is concerned with how closely related the elements
are. Stronger forms of connascence are considered to be more acceptable when the
elements involved are closer together. In the original <code>setup</code> method the
connascence of meaning ties the <code>Adapter</code> class to the specific adapters.</p>

<p>Let&rsquo;s take a look at Andre&rsquo;s refactoring.</p>
<pre><code class="highlight ruby"><span class="c1"># adapter.rb</span>

<span class="k">class</span> <span class="nc">Adapter</span>
  <span class="vi">@adapters</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">setup</span><span class="p">(</span><span class="n">uri_string</span><span class="p">)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">Addressable</span><span class="o">::</span><span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">uri_string</span><span class="p">)</span>

    <span class="k">unless</span> <span class="n">adapter</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="n">uri</span><span class="p">.</span><span class="nf">scheme</span><span class="p">]</span>
      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">uri_string</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2"> uri is not supported"</span>
    <span class="k">end</span>

    <span class="n">adapter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span>
    <span class="vi">@adapters</span> <span class="o">&lt;&lt;</span> <span class="n">adapter</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">[]</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
    <span class="vi">@adapters</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">adapter</span><span class="o">|</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">schemes</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">scheme</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># adapter/memory.rb</span>
<span class="k">class</span> <span class="nc">Adapter</span>
  <span class="k">class</span> <span class="nc">Memory</span>
    <span class="k">def</span> <span class="nf">schemes</span>
      <span class="p">[</span><span class="ss">:memory</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="c1"># Methods to communicate with DB omitted.</span>

    <span class="no">Adapter</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Adapter</span><span class="p">.</span><span class="nf">setup</span><span class="p">(</span><span class="s2">"memory://test"</span><span class="p">).</span><span class="nf">class</span>
<span class="c1"># =&gt; Adapter::Memory</span>
</code></pre>

<p>We still have Connascence of Meaning, but it is now isolated inside the
individual adapter class, an adapter will change if the URI scheme it supports
changes. The <em>locality</em> of connascence has been increased.</p>

<p>Each specific adapter will only have a small number of schemes that it matches,
rather than all of them. The <em>degree</em> of connascence has been reduced.</p>

<p>By increasing the locality and reducing the degree of connascence, Andre has
made the connascence of meaning more acceptable. The connascence of meaning
resulted in the <code>Adapter</code> abstraction depending on the details of the specific
adapters.</p>

<p>It also prevented the <code>Adapter</code> from being <em>Closed for Modification</em>. Any time
we add a new adapter we need to change the <code>Adapter</code> class to add another
branch to the switch statement. It violated the <a href="http://en.wikipedia.org/wiki/Open/closed_principle">Open/Closed Principle</a>.</p>

<p>Andre&rsquo;s refactoring reduced the degree and increased the locality of connascence
of meaning. This makes the code adhere more closely to both the Single
Responsibility Principle and the Open/Closed Principle.</p>

<p>I think this is a good example of what <a href="http://twitter.com/kevinrutherford">Kevin Rutherford</a> hints at in
<a href="http://silkandspinach.net/2012/09/03/the-problem-with-code-smells/">The problem with code smells</a>. By finding where our code is
more connascent &mdash; having the stronger forms of connascence, having a high
degree of connascence, or having low locality of connascence &mdash; and making
the connascence more acceptable, we will improve the design of our software.</p>

    </section>
  </article>

    </div>

    <aside id="sidebar">
      <ol id="recent-articles">
        <h2>
          Recent Articles
          <a href="/feed.xml" class="feed" title="Subscribe!"><i class="fa fa-rss"></i></a>
        </h2>
          <li><a href="/your-tests-want-you-to-change-your-design/">Your tests want you to change your design</a> <span>Dec 19</span></li>
          <li><a href="/test-first-diamonds/">Test first diamonds</a> <span>Dec  6</span></li>
          <li><a href="/connascence-and-inverting-dependencies/">Connascence and Inverting Dependencies</a> <span>Nov  7</span></li>
          <li><a href="/next-kickstart-academy-podcast-show-with-liz-keogh-and-chris-matts/">Next Kickstart Academy Podcast Show with Liz Keogh and Chris Matts</a> <span>Aug 21</span></li>
          <li><a href="/kickstart-academy-podcast-with-liz-keogh-and-corey-haines/">Kickstart Academy Podcast with Liz Keogh and Corey Haines</a> <span>Jul 31</span></li>
      </ol>

      <ul id="tags">
        <h2>Tags</h2>
          <li><a href="/tags/design/">Design</a></a></li>
          <li><a href="/tags/kata/">Kata</a></a></li>
          <li><a href="/tags/tdd/">TDD</a></a></li>
          <li><a href="/tags/apprenticeship/">apprenticeship</a></a></li>
          <li><a href="/tags/atdd/">atdd</a></a></li>
          <li><a href="/tags/bdd/">bdd</a></a></li>
          <li><a href="/tags/bletchley-park/">bletchley park</a></a></li>
          <li><a href="/tags/charlock_holmes/">charlock_holmes</a></a></li>
          <li><a href="/tags/chris-matts/">chris-matts</a></a></li>
          <li><a href="/tags/coderetreat/">coderetreat</a></a></li>
          <li><a href="/tags/connascence/">connascence</a></a></li>
          <li><a href="/tags/corey-haines/">corey-haines</a></a></li>
          <li><a href="/tags/craft/">craft</a></a></li>
          <li><a href="/tags/craftsmanship/">craftsmanship</a></a></li>
          <li><a href="/tags/cucumber/">cucumber</a></a></li>
          <li><a href="/tags/cynefin/">cynefin</a></a></li>
          <li><a href="/tags/deploymnent/">deploymnent</a></a></li>
          <li><a href="/tags/design/">design</a></a></li>
          <li><a href="/tags/dev/">dev</a></a></li>
          <li><a href="/tags/development/">development</a></a></li>
          <li><a href="/tags/eden/">eden</a></a></li>
          <li><a href="/tags/environment/">environment</a></a></li>
          <li><a href="/tags/fitnesse/">fitnesse</a></a></li>
          <li><a href="/tags/git/">git</a></a></li>
          <li><a href="/tags/github/">github</a></a></li>
          <li><a href="/tags/hacks/">hacks</a></a></li>
          <li><a href="/tags/heroku/">heroku</a></a></li>
          <li><a href="/tags/javascript/">javascript</a></a></li>
          <li><a href="/tags/jekyll/">jekyll</a></a></li>
          <li><a href="/tags/kickstartac/">kickstartac</a></a></li>
          <li><a href="/tags/libicu/">libicu</a></a></li>
          <li><a href="/tags/liz-keogh/">liz-keogh</a></a></li>
          <li><a href="/tags/macosx/">macosx</a></a></li>
          <li><a href="/tags/oo/">oo</a></a></li>
          <li><a href="/tags/oop/">oop</a></a></li>
          <li><a href="/tags/pairing/">pairing</a></a></li>
          <li><a href="/tags/podcast/">podcast</a></a></li>
          <li><a href="/tags/practices/">practices</a></a></li>
          <li><a href="/tags/project/">project</a></a></li>
          <li><a href="/tags/retrospective/">retrospective</a></a></li>
          <li><a href="/tags/ruby/">ruby</a></a></li>
          <li><a href="/tags/sandi-metz/">sandi-metz</a></a></li>
          <li><a href="/tags/sinatra/">sinatra</a></a></li>
          <li><a href="/tags/software/">software</a></a></li>
          <li><a href="/tags/solid/">solid</a></a></li>
          <li><a href="/tags/specification-by-example/">specification-by-example</a></a></li>
          <li><a href="/tags/tdd/">tdd</a></a></li>
          <li><a href="/tags/tools/">tools</a></a></li>
          <li><a href="/tags/training/">training</a></a></li>
          <li><a href="/tags/vim/">vim</a></a></li>
          <li><a href="/tags/xp/">xp</a></a></li>
      </ul>

      <div id="bio">
        <img class="avatar" src="/images/tooky-avatar.jpg">
        <h2>Steve Tooke</h2>
        <p>
        I am a programmer &mdash; consultant, trainer and coach &mdash;
        passionate about improving my craft and helping others improve
        theirs. I specialise in helping teams continue to deliver
        valuable software by improving their team practices and
        communication, and keeping their code maintainable.
        </p>
        <p>
        I co-organised Bootstrapd, a non-profit conference for
        bootstrapped startups in Europe. I am the co-founder of the
        Software Craftsmanship UK user group, and the HampshiRB ruby
        user group. I have spoken at the Scottish Ruby
        Conference and have run workshops at the London Software
        Craftsmanship Community. I am a member of the Cucumber core
        team.
        </p>
        <p>
        <a href="http://kickstartacademy.io">Kickstart Academy</a>
        </p>
      </div>
    </aside>
    <footer>
      <div id='site-footer'>
        <p>All content copyright Steve Tooke &copy; 2015 &middot; All rights reserved.</p>
        <p>Find me on <a href="http://twitter.com/tooky">Twitter</a> | <a href="https://plus.google.com/+SteveTooke-Heavies/">Google+</a></a></p>
    </div>
    </footer>
  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37664795-2', 'tooky.co.uk');
    ga('send', 'pageview');

  </script>
  </body>
</html>
