<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Steve Tooke - Using charklock_holmes on Heroku</title>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Merriweather:300italic,300|Source+Sans+Pro:300|Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link href="/stylesheets/reset.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/highlight.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/blog.css" rel="stylesheet" type="text/css" />
    <script src="/javascripts/track_outbound_links.js" type="text/javascript"></script>

  </head>
  <body>

  <div id='site-header'>
    <div id="site-header-wrapper">
      <h1>
        <a href="/">
          Steve Tooke
        </a>
      </h1>
      <h2>software development flavoured with agile, bdd, ruby and javascript</h2>
    </div>
  </div>
  <div id='main-wrapper'>
    <div id="main" role="main">
        <article>
    <header>
      <h1>Using charklock_holmes on Heroku</h1>
      <section class="author">
        <img class="avatar" src="/images/tooky-avatar.jpg">
        <p class="byline">by Steve Tooke</p>
        <time datetime="2014-06-11" itemprop="datePublished">June 11th, 2014</time>
      </section>
    </header>
    <section class="article-body">
      <p><a href="https://github.com/brianmario/charlock_holmes"><code>charlock_holmes</code></a> is a useful gem if you have to deal with
user supplied data which may come in a variety of text-encodings. Not only does
it enable you to detect the encoding of a string, but it also allows you to
transcode the string to a different encoding.</p>

<p><code>charklock_holmes</code> uses <a href="http://site.icu-project.org"><code>libicu</code></a> to deal with string encoding.</p>

<p>Unfortunately, the default <a href="https://www.heroku.com">Heroku</a> buildpack for Ruby doesn&rsquo;t include
<code>libicu</code> which prevents bundler from being able to compile <code>charklock_holmes</code>
C-extension.</p>

<p>There have been a few attempts at solving this problem, most of which are
discussed over on <a href="http://stackoverflow.com/questions/18926574/how-to-install-charlock-holmes-dependency-libicu-dev-on-heroku">stack overflow</a>. The <a href="http://stackoverflow.com/a/18926982/223996">accepted
answer</a> is a common solution, which relies on using
a version of the gem which includes a bundled version of <code>libicu</code>. While this
works, it does result in very slow build times both on heroku, and locally when
doing a bundle install.</p>

<p><a href="http://stackoverflow.com/a/20507705/223996">Another solution</a> uses a custom version of the ruby
buildpack which includes <code>libicu</code> &mdash; while this is a simple solution it
relies on the maintainer of that solution keeping it up to date with heroku&rsquo;s
ruby buildpack.</p>

<p><a href="http://stackoverflow.com/a/22662875/223996">My favourite solution</a> seems to move in the right direction,
it uses <a href="https://github.com/ddollar/heroku-buildpack-multi"><code>heroku-buildpack-multi</code></a> and
<a href="https://github.com/ddollar/heroku-buildpack-apt"><code>heroku-buildpack-apt</code></a> to install <code>libicu</code> using apt.
Unfortunately it uses a forked version of the <code>heroku-buildpack-apt</code> which
adds specific behaviour for <code>charlock_holmes</code> and where <code>bundler</code> can find the
version of <code>libicu</code> installed by <code>apt</code>.</p>

<p>My solution builds upon the previous solution, but rather than use a custom
version of the <code>heroku-buildpack-apt</code> I have added one more buildpack into the
mix &mdash; <a href="https://github.com/timolehto/heroku-bundle-config"><code>heroku-bundle-config</code></a>.</p>

<p>This buildpack allows you to configure your heroku bundler config in your
repository in the <code>.heroku-bundle</code> directory. During the build it will move this
directory to <code>.bundle</code>, and most importantly, make sure that all <code>/app</code> paths
point correctly to the temporary build directory.</p>

<p>I&rsquo;ve created a <a href="https://github.com/tooky/heroku-charlock-holmes">sample project</a>, that can be <a href="http://heroku-charlock-holmes.herokuapp.com">deployed to heroku</a> â€“ the only thing
you need to do is ensure that you have set the <code>BUILDPACK_URL</code> to
<code>https://github.com/ddollar/heroku-buildpack-multi.git</code>:</p>
<pre><code class="highlight plaintext">$ heroku config:set BUILDPACK_URL=https://github.com/ddollar/heroku-buildpack-multi.git
</code></pre>

<p>When you push to heroku, this buildpack will check for a <code>.buildpacks</code> file,
which specify the different buildpacks you want to use:</p>
<pre><code class="highlight plaintext">https://github.com/ddollar/heroku-buildpack-apt
https://github.com/timolehto/heroku-bundle-config
https://github.com/heroku/heroku-buildpack-ruby
</code></pre>

<p><code>heroku-buildpack-apt</code> will then check for an <code>Aptfile</code> and install the
specified packages:</p>
<pre><code class="highlight plaintext">libicu-dev
</code></pre>

<p>Finally, you need to configure you <code>.heroku-bundle/config</code> to make sure that
<code>bundler</code> can use your newly installed version of <code>libicu</code>:</p>
<pre><code class="highlight plaintext">---
BUNDLE_FROZEN: '1'
BUNDLE_PATH: vendor/bundle
BUNDLE_BIN: vendor/bundle/bin
BUNDLE_JOBS: 4
BUNDLE_WITHOUT: development:test
BUNDLE_DISABLE_SHARED_GEMS: '1'
BUNDLE_BUILD__CHARLOCK_HOLMES: --with-icu-lib=/app/.apt/usr/lib --with-icu-include=/app/.apt/usr/include
</code></pre>

<p>That should be all you need.</p>

    </section>
  </article>

    </div>

    <aside id="sidebar">
      <ol id="recent-articles">
        <h2>
          Recent Articles
          <a href="/feed.xml" class="feed" title="Subscribe!"><i class="fa fa-rss"></i></a>
        </h2>
          <li><a href="/the-mob-rules-ok/">The mob rules, ok?</a> <span>Dec  1</span></li>
          <li><a href="/hands-on-with-cucumber-events-api/">Hands-on With the Cucumber Events API</a> <span>Sep 14</span></li>
          <li><a href="/your-tests-want-you-to-change-your-design/">Your tests want you to change your design</a> <span>Dec 19</span></li>
          <li><a href="/test-first-diamonds/">Test first diamonds</a> <span>Dec  6</span></li>
          <li><a href="/connascence-and-inverting-dependencies/">Connascence and Inverting Dependencies</a> <span>Nov  7</span></li>
      </ol>

      <ul id="tags">
        <h2>Tags</h2>
          <li><a href="/tags/design/">Design</a></a></li>
          <li><a href="/tags/kata/">Kata</a></a></li>
          <li><a href="/tags/tdd/">TDD</a></a></li>
          <li><a href="/tags/apprenticeship/">apprenticeship</a></a></li>
          <li><a href="/tags/atdd/">atdd</a></a></li>
          <li><a href="/tags/bdd/">bdd</a></a></li>
          <li><a href="/tags/bletchley-park/">bletchley park</a></a></li>
          <li><a href="/tags/charlock_holmes/">charlock_holmes</a></a></li>
          <li><a href="/tags/chris-matts/">chris-matts</a></a></li>
          <li><a href="/tags/coderetreat/">coderetreat</a></a></li>
          <li><a href="/tags/connascence/">connascence</a></a></li>
          <li><a href="/tags/corey-haines/">corey-haines</a></a></li>
          <li><a href="/tags/craft/">craft</a></a></li>
          <li><a href="/tags/craftsmanship/">craftsmanship</a></a></li>
          <li><a href="/tags/cucumber/">cucumber</a></a></li>
          <li><a href="/tags/cynefin/">cynefin</a></a></li>
          <li><a href="/tags/deploymnent/">deploymnent</a></a></li>
          <li><a href="/tags/design/">design</a></a></li>
          <li><a href="/tags/dev/">dev</a></a></li>
          <li><a href="/tags/development/">development</a></a></li>
          <li><a href="/tags/eden/">eden</a></a></li>
          <li><a href="/tags/environment/">environment</a></a></li>
          <li><a href="/tags/fitnesse/">fitnesse</a></a></li>
          <li><a href="/tags/git/">git</a></a></li>
          <li><a href="/tags/github/">github</a></a></li>
          <li><a href="/tags/hacks/">hacks</a></a></li>
          <li><a href="/tags/heroku/">heroku</a></a></li>
          <li><a href="/tags/javascript/">javascript</a></a></li>
          <li><a href="/tags/jekyll/">jekyll</a></a></li>
          <li><a href="/tags/kickstartac/">kickstartac</a></a></li>
          <li><a href="/tags/libicu/">libicu</a></a></li>
          <li><a href="/tags/liz-keogh/">liz-keogh</a></a></li>
          <li><a href="/tags/macosx/">macosx</a></a></li>
          <li><a href="/tags/mobprogramming/">mobprogramming</a></a></li>
          <li><a href="/tags/oo/">oo</a></a></li>
          <li><a href="/tags/oop/">oop</a></a></li>
          <li><a href="/tags/pairing/">pairing</a></a></li>
          <li><a href="/tags/podcast/">podcast</a></a></li>
          <li><a href="/tags/practices/">practices</a></a></li>
          <li><a href="/tags/project/">project</a></a></li>
          <li><a href="/tags/retrospective/">retrospective</a></a></li>
          <li><a href="/tags/ruby/">ruby</a></a></li>
          <li><a href="/tags/sandi-metz/">sandi-metz</a></a></li>
          <li><a href="/tags/sinatra/">sinatra</a></a></li>
          <li><a href="/tags/software/">software</a></a></li>
          <li><a href="/tags/solid/">solid</a></a></li>
          <li><a href="/tags/specification-by-example/">specification-by-example</a></a></li>
          <li><a href="/tags/tdd/">tdd</a></a></li>
          <li><a href="/tags/tools/">tools</a></a></li>
          <li><a href="/tags/training/">training</a></a></li>
          <li><a href="/tags/vim/">vim</a></a></li>
          <li><a href="/tags/xp/">xp</a></a></li>
      </ul>

      <div id="bio">
        <img class="avatar" src="/images/tooky-avatar.jpg">
        <h2>Steve Tooke</h2>
        <p>
        I am a programmer &mdash; consultant, trainer and coach &mdash;
        passionate about improving my craft and helping others improve
        theirs. I specialise in helping teams continue to deliver
        valuable software by improving their team practices and
        communication, and keeping their code maintainable.
        </p>
        <p>
        I co-organised Bootstrapd, a non-profit conference for
        bootstrapped startups in Europe. I am the co-founder of the
        Software Craftsmanship UK user group, and the HampshiRB ruby
        user group. I have spoken at the Scottish Ruby
        Conference and have run workshops at the London Software
        Craftsmanship Community. I am a member of the Cucumber core
        team.
        </p>
        <p>
        <a href="http://kickstartacademy.io">Kickstart Academy</a>
        </p>
      </div>
    </aside>
    <footer>
      <div id='site-footer'>
        <p>All content copyright Steve Tooke &copy; 2017 &middot; All rights reserved.</p>
        <p>Find me on <a href="http://twitter.com/tooky">Twitter</a> | <a href="https://plus.google.com/+SteveTooke-Heavies/">Google+</a></a></p>
    </div>
    </footer>
  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37664795-2', 'tooky.co.uk');
    ga('send', 'pageview');

  </script>
  </body>
</html>
